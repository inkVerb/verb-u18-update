#!/usr/bin/env bash
#inkVerbSerf! verb.ink

# This installs phpMyAdmin via apt-get to a defiend directory, to become available at mysql.your-name.verb.vip/DEFINED-DIRECTORY

# How to use:
## ./installphpmyadminapt-get [directory]


# Include the configs
. /opt/verb/conf/sitenameip
. /opt/verb/conf/siteurilist

DIRECTRY=$1
MYSQL_ROOT_PASS=$(/bin/cat /opt/verb/conf/mysqlboss.cnf)
PHPMYADMIN_DIR="${DIRECTRY}"
AUTOGENERATED_PASS=`pwgen -c -1 20`

# Options
if [ -z ${1} ]; then
/bin/echo "You must designate a folder."
exit 8; fi

/bin/echo "phpmyadmin phpmyadmin/reconfigure-webserver multiselect apache2" | debconf-set-selections
/bin/echo "phpmyadmin phpmyadmin/dbconfig-install boolean true" | debconf-set-selections
/bin/echo "phpmyadmin phpmyadmin/mysql/admin-user string root" | debconf-set-selections
/bin/echo "phpmyadmin phpmyadmin/mysql/admin-pass password ${MYSQL_ROOT_PASS}" | debconf-set-selections
/bin/echo "phpmyadmin phpmyadmin/mysql/app-pass password ${AUTOGENERATED_PASS}" | debconf-set-selections
/bin/echo "phpmyadmin phpmyadmin/app-password-confirm password ${AUTOGENERATED_PASS}" | debconf-set-selections

/usr/bin/apt-get -y install phpmyadmin

##16 Below may not be necessary and has been commented
# Regex FTW!
#sed -i -r "s:(Alias /).*(/usr/share/phpmyadmin):\1${PHPMYADMIN_DIR} \2:" /etc/phpmyadmin/apache.conf

##16 this was updated from php5enmod, it may not be an issue in Ubuntu 16.04
#phpenmod mcrypt # Needs to be activated manually (that's an issue for Ubuntu 14.04)

/bin/ln -s /usr/share/phpmyadmin /var/www/html/vip.mysql/${PHPMYADMIN_DIR}
/bin/chown -R www-data:www-data vip.mysql

/usr/sbin/apache2ctl graceful

/bin/echo "
PHP My Admin now active.

After creating a database \"boss\" user, log in at http://mysql.${vipURI}/${DIRECTRY}
"

