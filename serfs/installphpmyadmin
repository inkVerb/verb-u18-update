#!/usr/bin/env bash
#inkVerbSerf! verb.ink
set -e

# This installs phpMyAdmin to a defiend directory, to become available at mysql.your-name.verb.guru/DEFINED-DIRECTORY

# How to use:
## ./installphpmyadmin [directory]


# Include the configs
. /var/local/verb/configs/sitenameip
. /var/local/verb/configs/siteurilist

DIRECTRY=$1
MYSQL_ROOT_PASS=$(cat /var/local/verb/configs/mysqlboss.cnf)
PHPMYADMIN_DIR="${DIRECTRY}"
AUTOGENERATED_PASS=`pwgen -c -1 20`

# Options
if [ -z $1 ]; then
echo "You must designate a folder."
exit 22; fi

echo "phpmyadmin phpmyadmin/reconfigure-webserver multiselect apache2" | debconf-set-selections
echo "phpmyadmin phpmyadmin/dbconfig-install boolean true" | debconf-set-selections
echo "phpmyadmin phpmyadmin/mysql/admin-user string root" | debconf-set-selections
echo "phpmyadmin phpmyadmin/mysql/admin-pass password ${MYSQL_ROOT_PASS}" | debconf-set-selections
echo "phpmyadmin phpmyadmin/mysql/app-pass password ${AUTOGENERATED_PASS}" | debconf-set-selections
echo "phpmyadmin phpmyadmin/app-password-confirm password ${AUTOGENERATED_PASS}" | debconf-set-selections

apt -y install phpmyadmin

##16 Below may not be necessary and has been commented
# Regex FTW!
#sed -i -r "s:(Alias /).*(/usr/share/phpmyadmin):\1${PHPMYADMIN_DIR} \2:" /etc/phpmyadmin/apache.conf

##16 this was updated from php5enmod, it may not be an issue in Ubuntu 16.04
phpenmod mcrypt # Needs to be activated manually (that's an issue for Ubuntu 14.04)

ln -s /usr/share/phpmyadmin /var/www/html/guru.mysql/${PHPMYADMIN_DIR}
chown -R www-data:www-data guru.mysql

service apache2 reload

echo "
PHP My Admin now active.

After creating a database \"boss\" user, log in at http://mysql.${guruURI}/${DIRECTRY}
"

